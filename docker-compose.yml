services:
  # Elasticsearch - 로컬 개발용
  # 서버 ES를 쓸 경우 이 서비스를 주석 처리하고 .env에서 ES_URL을 서버 주소로 변경
  elasticsearch:
    container_name: elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.10
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Backend (로컬 빌드, 서버 DB/Valkey는 SSM 터널로 접근)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inventory-backend
    ports:
      - "8080:8080"
    environment:
      # dev == local 의미로 사용
      - SPRING_PROFILES_ACTIVE=dev

      # ★ 중요: RDS(공용/서버 DB) 붙을 때 dev의 ddl-auto=create는 위험하므로,
      # docker-compose에서 안전하게 덮어쓰기 권장
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      # 필요하면 validate 대신 none도 고려 가능:
      # - SPRING_JPA_HIBERNATE_DDL_AUTO=none
    env_file:
      - .env
    depends_on:
      elasticsearch:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # (선택) 만약 Valkey TLS 핸드셰이크에서 호스트네임 검증 문제 등이 생기면,
    # 아래처럼 엔드포인트 호스트를 host-gateway로 매핑하고,
    # .env의 REDIS_HOST를 실제 엔드포인트로 바꾸는 방식으로 해결할 수 있습니다.
    # - "<VALKEY_ENDPOINT>:host-gateway"
    # - "<RDS_ENDPOINT>:host-gateway"

  # Frontend (로컬 빌드 + Nginx)
  web:
    build:
      context: ../AIBE4_FinalProject_Team1_FE
      dockerfile: Dockerfile
    container_name: inventory-web
    depends_on:
      - backend
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

  # Monitoring Stack
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - "9100:9100"
    restart: unless-stopped

  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - loki_data:/loki
      - ./loki-config.yml:/etc/loki/local-config.yaml
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    depends_on:
      - prometheus
      - loki
    restart: unless-stopped

volumes:
  es-data:
  prometheus_data:
  grafana_data:
  loki_data:
